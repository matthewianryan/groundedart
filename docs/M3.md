# Milestone 3 — Verification state machine (implementation review)

This document summarizes the current Milestone 3 implementation in this repo (per `docs/ROADMAP.md`), focused on **server-enforced capture verification states**, **auditable transitions**, **basic anti-abuse**, and a **minimal admin moderation surface**.

## Capture states + server-enforced transitions
- Capture states are defined as a strict enum in `apps/api/src/groundedart_api/domain/capture_state.py`: `draft`, `pending_verification`, `verified`, `rejected`, `hidden`.
- Allowed transitions are enforced centrally via `assert_valid_capture_transition(...)`:
  - `draft → pending_verification|hidden`
  - `pending_verification → verified|rejected|hidden`
  - `verified → hidden`
  - `rejected → hidden`
  - `hidden → (terminal)`
- The upload path performs a server-side promotion on first image upload:
  - `POST /v1/captures/{id}/image` promotes `draft → pending_verification` (reason: `image_uploaded`) in `apps/api/src/groundedart_api/api/routers/captures.py`.

## Reason codes (validated; explainable)
- Reason codes are defined as a strict enum in `packages/domain/schemas/capture_state_reason_code.json` and mirrored in `apps/api/src/groundedart_api/domain/capture_state_reason_code.py`.
- Reason requirements are enforced in `apps/api/src/groundedart_api/domain/capture_transitions.py`:
  - `pending_verification`, `rejected`, `hidden` require a non-null reason code.
  - `draft` and `verified` allow a null reason, but still validate any provided reason code.
- The API persists the reason code in `captures.state_reason` (DB model: `apps/api/src/groundedart_api/db/models.py`).

## Audit log (append-only, state transitions)
- Every capture state transition writes an append-only audit row in `capture_state_events`:
  - Storage model: `apps/api/src/groundedart_api/db/models.py` (`CaptureStateEvent`)
  - Migration: `apps/api/src/groundedart_api/db/migrations/versions/20260123_0005_capture_state_events.py`
- The transition helper `apply_capture_transition_with_audit(...)` in `apps/api/src/groundedart_api/domain/capture_state_events.py` is used by:
  - Upload promotion in `apps/api/src/groundedart_api/api/routers/captures.py` (`actor_type="user"`)
  - Admin moderation in `apps/api/src/groundedart_api/domain/capture_moderation.py` (`actor_type="admin"`)

## Minimal moderation surface (admin endpoints)
- Admin authentication is a shared secret header gate: `X-Admin-Token` checked by `apps/api/src/groundedart_api/auth/deps.py:require_admin` (token value comes from `apps/api/src/groundedart_api/settings.py:admin_api_token` / `.env`).
- Admin endpoints live under `apps/api/src/groundedart_api/api/routers/admin.py`:
  - `GET /v1/admin/captures/pending` (queue for review; supports optional filters)
  - `POST /v1/admin/captures/{capture_id}/transition` (targets: `verified|rejected|hidden`; requires reason where applicable)
  - `GET /v1/admin/abuse-events` (review suspicious behavior)

## Basic anti-abuse (rate limits + caps + tracking)
- Server-enforced limits (tunable via `apps/api/src/groundedart_api/settings.py`):
  - Check-in challenge rate limiting (per user/node/window) in `apps/api/src/groundedart_api/api/routers/nodes.py`.
  - Capture creation rate limiting (per user/node/window) in `apps/api/src/groundedart_api/api/routers/captures.py` and also enforced during check-in issuance in `apps/api/src/groundedart_api/api/routers/nodes.py`.
  - Per-node cap on pending verification volume enforced on upload promotion in `apps/api/src/groundedart_api/api/routers/captures.py` (`max_pending_verification_captures_per_node`).
- Suspicious behavior tracking is persisted (not just logged) in `abuse_events`:
  - Storage model: `apps/api/src/groundedart_api/db/models.py` (`AbuseEvent`)
  - Migration: `apps/api/src/groundedart_api/db/migrations/versions/20260123_0006_abuse_events.py`
  - Recording helper: `apps/api/src/groundedart_api/domain/abuse_events.py`

## Async verification/scoring hook boundary (no-op by default)
- The async boundary is the `VerificationEventEmitter` protocol in `apps/api/src/groundedart_api/domain/verification_events.py`.
- Current implementation is a no-op emitter (dependency-injected), but the hook is invoked on:
  - Upload promotion (`capture_uploaded(...)`) in `apps/api/src/groundedart_api/api/routers/captures.py`.
  - Admin moderation transitions (`capture_state_changed(...)`) in `apps/api/src/groundedart_api/domain/capture_moderation.py`.

## “Verified captures” uses real verification state (web)
- Node detail fetches verified captures from the API and renders thumbnails:
  - UI: `apps/web/src/routes/NodeDetailRoute.tsx`
  - API client: `apps/web/src/features/captures/api.ts:listNodeCaptures`
  - API endpoint: `GET /v1/nodes/{node_id}/captures` in `apps/api/src/groundedart_api/api/routers/nodes.py` (defaults to `state=verified`).
- Non-verified capture enumeration is admin-gated: requesting `state != verified` requires `X-Admin-Token` (enforced in `apps/api/src/groundedart_api/api/routers/nodes.py`).

## Test coverage touching M3
- Transition validity unit tests: `apps/api/tests/test_capture_state.py`
- Audit log behavior: `apps/api/tests/test_capture_audit.py`, `apps/api/tests/test_admin_moderation.py`
- Admin moderation endpoints and auth: `apps/api/tests/test_admin_moderation.py`
- Async hook boundary + event emission: `apps/api/tests/test_verification_events.py`
- Error code stability includes anti-abuse/admin codes: `apps/api/tests/test_error_contracts.py`

## Areas to address / review
- **No admin UI yet**: M3 is satisfied via admin endpoints, but there is no web moderation interface (only API surface in `apps/api/src/groundedart_api/api/routers/admin.py`).
- **Domain schemas missing for abuse admin responses**: `packages/domain/schemas/` includes admin capture moderation schemas, but does not define schemas for `GET /v1/admin/abuse-events` responses (currently only represented in `apps/api/src/groundedart_api/api/schemas.py`).
- **Capture creation has no audit row**: the audit log covers transitions, but there is no explicit “created draft” audit event (creation is only visible via `captures.created_at` and the first transition event).
