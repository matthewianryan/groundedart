# Tasks

### M5-07 — Solana-native tipping (hackathon TODO) — epic
- **Context (what/why):**
  - We want a credible “artist value loop” (tips) without deploying a custom on-chain program or turning the API into a chain indexer.
  - Canonical hackathon decisions (source of truth: `docs/FUTUREOPTIONS.md`):
    - **Chain**: Solana devnet only.
    - **Assets**: SOL-only.
    - **On-chain integration**: one system transfer + one Memo instruction containing the `tip_intent_id`.
    - **Receipts**: API verifies receipts via Solana RPC; no client-trusted fields.
- **Change plan (files):**
  - Implement the work via the concrete tasks below (M5-07a…M5-07g), keeping tips feature-flagged at the web/UI layer.
  - Cross-cutting doc + env updates:
    - `.env.example` (Solana RPC vars)
    - `docs/COMMANDS.md` (local dev + demo instructions)
- **Contracts:**
  - Endpoints (canonical shapes defined in subtasks):
    - `POST /v1/tips/intents`
    - `POST /v1/tips/confirm`
    - `GET /v1/nodes/{node_id}/tips`
  - The Memo must include `tip_intent_id` and is the canonical linkage between intent and on-chain tx.
- **Acceptance criteria:**
  - Demoable end-to-end: create intent → wallet sends transfer+memo → confirm verifies/stores receipt → node tips endpoint reflects stored totals.
- **Non-goals:**
  - USDC/SPL tokens, custom Solana programs, chain scanning/indexing, wallet↔user claim flows.

### M5-07a — Add artists + default tip target per node
- **Context (what/why):**
  - Tips need an authoritative recipient that is not client-supplied. For hackathon, the recipient is the **default artist per node**.
- **Change plan (files):**
  - DB + models:
    - Alembic migration under `apps/api/src/groundedart_api/db/migrations/versions/` to add:
      - `artists` table with at least `{ id, display_name, solana_recipient_pubkey, created_at, updated_at }`
      - `nodes.default_artist_id` (nullable at first) → `artists.id`
    - Update `apps/api/src/groundedart_api/db/models.py` with `Artist` model and `Node.default_artist_id` (and relationship if desired).
  - Seeding / local demo ergonomics:
    - Add a simple seeding script `apps/api/scripts/seed_artists.py` (or extend `apps/api/scripts/seed_nodes.py`) to create demo artists and link nodes.
- **Contracts:**
  - Define a canonical representation for a Solana pubkey in contracts:
    - base58 string, validated format, stored exactly as provided by admin/seed tooling.
  - Define failure behavior for nodes that don’t have a default artist:
    - tip intent creation must fail with a stable error code (defined in M5-07b).
- **Acceptance criteria:**
  - At least one node in a fresh dev DB can be seeded with a `default_artist_id` that points at an `artists` row with a valid `solana_recipient_pubkey`.
  - The DB enforces referential integrity (FK) and prevents obviously invalid pubkey shapes at the API boundary (format validation).
- **Non-goals:**
  - Artist claim/verification flows, multiple artists per node, or artworks/artist attribution expansions beyond the `artists` table.

### M5-07b — Tip intents: persistence + `POST /v1/tips/intents`
- **Context (what/why):**
  - Intents are the server-issued “payment plan” that the wallet must execute. The intent id must appear in the Memo to create a verifiable linkage.
- **Change plan (files):**
  - DB + models:
    - Alembic migration under `apps/api/src/groundedart_api/db/migrations/versions/` to add `tip_intents` (per `docs/FUTUREOPTIONS.md`), including:
      - `id` (this is `tip_intent_id`)
      - `node_id`, `artist_id`, `amount_lamports`, `to_pubkey` (snapshotted), `created_by_user_id`
      - `expires_at`, `status`
    - Update `apps/api/src/groundedart_api/db/models.py` with `TipIntent`.
  - API:
    - New router `apps/api/src/groundedart_api/api/routers/tips.py` implementing `POST /v1/tips/intents`.
    - Wire the router in `apps/api/src/groundedart_api/main.py`.
    - Add request/response models in `apps/api/src/groundedart_api/api/schemas.py`.
  - Shared schemas:
    - Add schemas under `packages/domain/schemas/` (names final in this task), e.g.:
      - `create_tip_intent_request.json`
      - `tip_intent_response.json`
      - `tip_error_code.json` (+ error response schema if needed)
  - Tests:
    - Add API tests under `apps/api/tests/test_tips_intents.py`.
- **Contracts:**
  - `POST /v1/tips/intents` request: `{ node_id, amount_lamports }`.
  - Response must include canonical fields the wallet uses:
    - `{ tip_intent_id, to_pubkey, amount_lamports, cluster: \"devnet\", memo_text }`.
  - Stable error codes for:
    - node not found
    - node missing default artist
    - artist missing/invalid recipient pubkey
    - invalid amount (<= 0 or above a configured max, if we choose to cap)
- **Acceptance criteria:**
  - Intent creation fails fast with stable error codes when the node/artist/amount constraints aren’t met.
  - Returned `memo_text` unambiguously contains the `tip_intent_id` and is safe to embed as a Solana Memo (size limits respected).
  - Tests cover happy path and at least two failure modes.
- **Non-goals:**
  - Multiple intents per node aggregation or any kind of “tip presets” UI (beyond a simple amount picker).

### M5-07c — Tip confirmation: on-chain verification + receipt persistence
- **Context (what/why):**
  - The server must authoritatively verify that a specific on-chain tx paid the canonical recipient the canonical lamports, and that the Memo links to the intent id.
- **Change plan (files):**
  - Adapter boundary:
    - Add `apps/api/src/groundedart_api/domain/tip_receipts.py` defining:
      - provider interface for fetching/parsing tx details
      - verification result types + error reasons
    - Add a Solana-devnet implementation (e.g. `apps/api/src/groundedart_api/domain/tip_receipts_solana.py`) that:
      - fetches the transaction via Solana JSON-RPC
      - finds the Memo text and validates inclusion of `tip_intent_id`
      - validates a system transfer instruction paying `to_pubkey` exactly `amount_lamports`
      - extracts `from_pubkey` (fee payer / signer used for the transfer)
  - DB + models:
    - Alembic migration under `apps/api/src/groundedart_api/db/migrations/versions/` to add `tip_receipts` (per `docs/FUTUREOPTIONS.md`), including:
      - `tip_intent_id` (unique unless we explicitly allow multiple attempts)
      - `tx_signature` (unique)
      - `from_pubkey`, `to_pubkey`, `amount_lamports`, `slot`, `block_time`
      - `confirmation_status` (`seen`/`confirmed`/`finalized`/`failed`)
      - `first_seen_at`, `last_checked_at`, `failure_reason`
    - Update `apps/api/src/groundedart_api/db/models.py` with `TipReceipt`.
  - API:
    - Implement `POST /v1/tips/confirm` in `apps/api/src/groundedart_api/api/routers/tips.py`.
    - Add request/response models in `apps/api/src/groundedart_api/api/schemas.py`.
  - Shared schemas:
    - Add under `packages/domain/schemas/` (names final in this task), e.g.:
      - `confirm_tip_request.json`
      - `tip_receipt_public.json`
      - `tip_receipt_status.json` (enum)
  - Tests:
    - Add API tests under `apps/api/tests/test_tips_confirm.py` using mocked Solana RPC responses (no live chain dependency in CI).
- **Contracts:**
  - `POST /v1/tips/confirm` request: `{ tip_intent_id, tx_signature }`.
  - Idempotency rules (must be enforced at DB + API):
    - same `(tip_intent_id, tx_signature)` can be retried safely
    - `tx_signature` cannot credit multiple intents
  - Verification rules (server-authoritative):
    - never trust client-submitted `to_pubkey`, `amount_lamports`, or `from_pubkey`
    - memo must contain the `tip_intent_id` (server must find it in fetched tx)
    - reject/mark failed if intent is expired or tx does not match canonical recipient/amount
- **Acceptance criteria:**
  - A valid transfer+memo tx results in a stored receipt with status at least `seen` (and upgraded later by reconciliation).
  - Invalid txs (wrong recipient, wrong amount, missing memo) are rejected/recorded as `failed` with a stable failure reason.
  - Retries do not create duplicate credits (uniqueness constraints + idempotent API behavior).
- **Non-goals:**
  - Supporting SPL tokens, splits/fees, or any “pay-to-post” gating in hackathon scope.

### M5-07d — Receipt reconciliation job (finality upgrades)
- **Context (what/why):**
  - The API must not treat “seen once” as final; receipts should progress to `confirmed`/`finalized` and be marked `failed` if dropped.
- **Change plan (files):**
  - Implement a periodic reconciler:
Decision: a script in `apps/api/scripts/reconcile_tip_receipts.py` run by cron / a separate container.
  - Add minimal settings in `apps/api/src/groundedart_api/settings.py`:
    - Solana RPC URL(s)
    - reconciliation interval and cutoff window
  - (If using containers) add a new service in `infra/docker-compose.yml` for the reconciler.
  - Tests:
    - unit tests for “status upgrade rules” (pure functions) and a small integration test that exercises DB selection/update logic.
- **Contracts:**
  - Define canonical transitions:
    - `seen`/`confirmed` → `finalized` when RPC reports finalization
    - mark `failed` when tx is missing/dropped past a cutoff window
  - Ensure `last_checked_at`, `slot`, and `block_time` are updated when discovered.
- **Acceptance criteria:**
  - A receipt created by confirm can be upgraded to `finalized` by running the reconciler.
  - Reconciler is safe to run repeatedly (no double-counting side effects; idempotent updates).
- **Non-goals:**
  - Chain-wide indexing or discovery of tips that were never confirmed via our API.

### M5-07e — Node tips read API: `GET /v1/nodes/{node_id}/tips`
- **Context (what/why):**
  - The UI needs a fast, server-authoritative way to show tip totals and recent receipts without scanning the chain.
- **Change plan (files):**
  - API:
    - Add `GET /v1/nodes/{node_id}/tips` in `apps/api/src/groundedart_api/api/routers/tips.py` (or `nodes.py` if we decide to keep node reads grouped).
    - Query stored receipts (no chain scanning) and return:
      - total amount (lamports/SOL) for the node (and/or artist) scoped to finalized (or at least confirmed) receipts
      - a short list of recent receipts with status and timestamps
  - Shared schemas:
    - Add under `packages/domain/schemas/` (names final in this task), e.g. `node_tips_response.json`.
  - Tests:
    - API tests under `apps/api/tests/test_node_tips.py`.
- **Contracts:**
  - Define whether totals include `confirmed` or only `finalized` (pick one; document it in the schema and endpoint docstring).
  - The endpoint must never rely on RPC calls for normal operation (DB-backed only).
- **Acceptance criteria:**
  - The endpoint returns deterministic totals based on stored receipts and includes statuses for recent receipts.
  - Tests cover empty state and a mixed-status set of receipts.
- **Non-goals:**
  - Leaderboards, historical analytics, or aggregations that require chain scanning.

### M5-07f — Web: Solana Wallet Adapter + tip UX
- **Context (what/why):**
  - Tips must be initiated from a wallet users already have (Phantom/Solflare), with minimal UI friction and a verifiable memo linkage.
- **Change plan (files):**
  - Dependencies:
    - Add Solana Wallet Adapter packages in `apps/web/package.json`.
  - New tip feature module:
    - Add `apps/web/src/features/tips/` implementing:
      - API calls to `POST /v1/tips/intents` and `POST /v1/tips/confirm`
      - transaction builder: system transfer + Memo containing `memo_text`
      - UI states: connect wallet, choose amount, send, confirming, success/failure
  - Integrate into node UI:
    - Update `apps/web/src/routes/NodeDetailRoute.tsx` to show a “Tip the artist” UI if the node supports tips (server indicates eligibility or we feature-flag).
  - Tests:
    - Add vitest tests for the tip flow state machine (mock wallet + mock API).
- **Contracts:**
  - The web client must use only the canonical fields returned by the intent endpoint:
    - recipient pubkey, lamports amount, memo text, cluster
  - The client must never construct its own `tip_intent_id` or modify the memo format.
- **Acceptance criteria:**
  - A user can connect a wallet, create an intent, send a transfer+memo on devnet, and confirm it with the API.
  - UI clearly communicates non-final states (`seen`/`confirmed`) and that finalization may update later.
- **Non-goals:**
  - Multi-wallet account management, token selection, or cross-chain support.

### M5-07g — Demo/ops: env vars, docs, and devnet funding checklist
- **Context (what/why):**
  - Hackathon demos fail on setup friction. We need a documented, reproducible way to configure RPC, seed recipients, and fund wallets.
- **Change plan (files):**
  - Config:
    - Add required env vars to `.env.example` (API and web as needed), e.g. `SOLANA_RPC_URL`, `SOLANA_CLUSTER=devnet`.
  - Docs:
    - Update `docs/COMMANDS.md` with:
      - how to seed a demo artist recipient pubkey
      - how to fund demo wallets with devnet SOL (faucet story)
      - how to run the reconciler (if separate)
    - Add a short section to `docs/FUTUREOPTIONS.md` cross-linking the concrete tasks in `docs/TASKS.md` (optional but recommended).
- **Contracts:**
  - Document which RPC commitment levels we use for confirm/reconciliation and why (`confirmed` vs `finalized`).
- **Acceptance criteria:**
  - A new developer can follow the docs to run the full tip loop locally against devnet without ad-hoc tribal knowledge.
- **Non-goals:**
  - Production-grade RPC provider selection, rate-limit tuning, or on-chain monitoring dashboards.

### M5-06 — (Optional) Tip receipt integration behind an adapter boundary
- **Context (what/why):**
  - We want “proof of tip” without coupling the core capture pipeline to any specific payments/on-chain system.
  - New decision (canonical hackathon plan; see `docs/FUTUREOPTIONS.md`):
    - **Chain**: Solana devnet only.
    - **Assets**: SOL-only (no USDC/SPL).
    - **On-chain integration**: no custom program; plain SOL transfer + Memo containing `tip_intent_id`.
    - **Verification**: API verifies the receipt by fetching the transaction from Solana RPC and validating recipient/amount + memo linkage.
- **Change plan (files):**
  - Define an adapter boundary (so we can swap chains/providers later):
    - New protocol/module: `apps/api/src/groundedart_api/domain/tip_receipts.py` (provider interface + core types).
    - Dependency injection wiring similar to `apps/api/src/groundedart_api/domain/verification_events.py`.
    - Implement a Solana-devnet provider behind the interface (Memo-linked transfer verification via RPC).
  - DB + models (intent + receipt persistence):
    - Add `artists` and link nodes to a default tip target:
      - `artists.solana_recipient_pubkey` (validated base58 string)
      - `nodes.default_artist_id` → `artists.id`
    - Add `tip_intents` + `tip_receipts` tables (see `docs/FUTUREOPTIONS.md` for suggested columns).
    - Decide and enforce idempotency (recommended):
      - `tip_receipts.tx_signature` unique
      - `tip_receipts.tip_intent_id` unique (unless we explicitly allow multiple attempts)
  - API endpoints (illustrative; names may be finalized here):
    - `POST /v1/tips/intents` → `{ node_id, amount_lamports }` → canonical payment payload `{ tip_intent_id, to_pubkey, amount_lamports, cluster, memo_text }`.
    - `POST /v1/tips/confirm` → `{ tip_intent_id, tx_signature }` → server RPC verification + stored receipt/status.
    - `GET /v1/nodes/{node_id}/tips` → totals + recent receipts backed by stored receipts (no chain scanning).
  - Web:
    - Wallet adapter + tip UI that constructs a transfer + Memo containing the canonical memo text.
    - Feature-flagged so the core app ships without tips enabled.
- **Contracts:**
  - Provider-specific behavior must be encapsulated behind the adapter boundary.
  - Verification rules must be explicit and server-authoritative:
    - Never trust client-submitted `to_pubkey`, `amount`, or `from_pubkey`.
    - The server must find the `tip_intent_id` in the fetched transaction Memo and verify the canonical recipient/lamports.
  - Add shared schemas in `packages/domain/schemas/` for tips payloads and error codes (names to decide in this task).
- **Acceptance criteria:**
  - The codebase has a clear adapter seam so other chains/providers can be added later without changing capture core flows.
  - Devnet SOL-only happy path works end-to-end:
    - create intent → wallet sends transfer+memo → confirm stores receipt → node tips endpoint reflects it.
  - Idempotency holds: retries cannot double-credit the same `tx_signature`.
- **Non-goals:**
  - USDC/SPL token tips.
  - Any custom Solana program / PDA receipts.
  - Chain scanning/indexing beyond stored receipts.
  - Wallet↔user claim flows (beyond recording `from_pubkey` on receipts).
