# Milestone 2 — Capture + upload (implementation review)

This document summarizes the current Milestone 2 implementation and the decisions that shaped it. It reflects the completed tasks in `docs/TASKS.md` plus the first three test-focused tasks (T-01 to T-03).

## Canonical flow and contracts
- **Order is fixed**: create capture, then upload image (`POST /v1/captures` → `POST /v1/captures/{id}/image`). This ordering is documented in `docs/ARCHITECTURE.md` and `docs/ROADMAP.md`.
- **Storage is API-terminated** for M2. The client uploads to the API, and the API writes to its media directory (no object storage or direct upload yet).
- **Retry-only resiliency**: uploads restart from byte 0 on failure. Resumable/chunked uploads are explicitly deferred to `docs/FUTUREOPTIONS.md`.
- **Error contracts** for capture/upload use stable `error.code` values declared in `packages/domain/schemas/capture_error_code.json` and mirrored in `apps/web/src/features/captures/api.ts`.

## Web capture UX (camera-first)
- Capture routes (`/capture` and `/capture/:id`) host the camera-first flow, wired in `apps/web/src/App.tsx`.
- `apps/web/src/features/captures/CaptureFlow.tsx` implements explicit states: `capturing → processing → preview → submitting → uploading → success/failure`.
- The flow prefers navigation state from the map but can reload with a `captureId` and fetch context from the API. It supports retake, cancel, and retry actions at each stage.
- The map route (`apps/web/src/routes/MapRoute.tsx`) includes a pending upload panel that lists queued/failed items and allows manual retry or removal.

## Client-side image preprocessing
- `apps/web/src/features/captures/imagePreprocess.ts` re-encodes images to JPEG, strips EXIF by design, and targets:
  - max dimension: 1600px
  - max size: 1.5MB
  - quality: adaptive with quality/resize backoff
- Orientation correctness is handled via `createImageBitmap(..., { imageOrientation: "from-image" })` when available.
- Tests in `apps/web/src/features/captures/imagePreprocess.test.ts` cover orientation-aware decode, size reduction behavior, and unsupported types.

## Resilient upload queue (retry + persistence)
- Upload intent persistence uses IndexedDB (`apps/web/src/features/captures/indexedDb.ts`) with a single object store keyed by `captureId`.
- `UploadQueue` (`apps/web/src/features/captures/uploadQueue.ts`) owns:
  - persistence, snapshot subscriptions, and a single active uploader
  - bounded exponential backoff with jitter (max attempts: 6)
  - retryable classification (HTTP 5xx/429 or network errors retry; 4xx do not)
- `useUploadQueue` surfaces counts and actions for UI; uploads resume automatically when the app starts and when the browser comes online.

## API upload robustness
- `apps/api/src/groundedart_api/api/routers/captures.py` creates captures in `draft` (pending upload) and promotes them to `pending_verification` on upload, with ownership checks.
- `apps/api/src/groundedart_api/storage/local.py` enforces:
  - allowed MIME types (`upload_allowed_mime_types`)
  - max bytes (`upload_max_bytes`)
  - atomic writes via a temp file + rename
  - stable error codes: `invalid_media_type`, `file_too_large`, `upload_incomplete`
- **Idempotency decision**: repeat uploads for the same capture overwrite the stored asset (safe retry semantics).
- Upload settings live in `apps/api/src/groundedart_api/settings.py` and are injected in tests to keep limits deterministic.

## Tests and verification (done so far)
- **T-01**: time injection via `groundedart_api/time.py` and `get_utcnow` dependency overrides; media storage isolation via `MEDIA_DIR` fixture in `apps/api/tests/conftest.py`.
- **T-02**: session tests in `apps/api/tests/test_sessions.py` validate device reuse, cookie attributes, and TTL handling.
- **T-03**: auth gate tests in `apps/api/tests/test_auth_gates.py` verify required/optional auth behavior and anonymous rank gating.
- Capture and upload coverage added in `apps/api/tests/test_capture_tokens.py` and `apps/api/tests/test_capture_uploads.py`.
- Manual weak-network checklist is documented in `docs/COMMANDS.md`.

## Areas to address
- **Capture route reload**: `/capture` relies on navigation state for `node` and `checkinToken`; a refresh drops context and forces users back to `/map`.
- **Pre-upload offline gap**: if the network fails before `POST /v1/captures`, the photo is not persisted locally. This is aligned with current ordering but limits offline capture recovery.
- **IndexedDB quota/availability**: upload intent persistence fails in some browser modes (private browsing, low quota). The UI surfaces the error, but capture creation can still succeed and leave an unuploadable capture without a retry path after closing the tab.
