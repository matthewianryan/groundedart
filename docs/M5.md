# Milestone 5 — Attribution + rights (implementation review)

This document summarizes what Milestone 5 (“Attribution + rights”) is implementing in this repo (per `docs/ROADMAP.md` and the M5 tasks in `docs/TASKS.md`): captures are **private by default**, “public” is an explicit server-enforced state, and we have a **manual-first reporting + takedown** path with an audit trail.

## Status vs `docs/TASKS.md`
- **M5-01 (policy doc):** implemented (`docs/ATTRIBUTION_RIGHTS.md`).
- **M5-02 (DB + shared contracts):** implemented (capture visibility/rights fields and reporting schemas).
- **M5-03 (read-path enforcement):** implemented for the current non-owner image surface (`GET /v1/nodes/{node_id}/captures`).
- **M5-04 (explicit publish path):** implemented in the API; web UI collects the fields but does not yet expose a publish action.
- **M5-05 (reporting + takedown):** implemented end-to-end (user report → admin resolve → capture hidden).
- **M5-06 (tip receipt adapter seam):** not implemented.

## Policy (source of truth)
- The canonical policy is defined in `docs/ATTRIBUTION_RIGHTS.md` as explicit if/then rules.
- “Public” is defined as: `state == verified` AND `visibility == public` AND required attribution fields are present AND rights are attested.
- Verification alone does not make a capture public; publishing is an explicit owner action.

## Persistence + contracts (what we added)

### DB (captures + reports)
- `captures.visibility` (`private|public`, default `private`)
- `captures.attribution_source`, `captures.attribution_source_url`
- `captures.rights_basis` (intended enum: `i_took_photo|permission_granted|public_domain`)
- `captures.rights_attested_at` (timestamp set by the server when the owner attests)
- `content_reports` table with reason/details plus `resolved_at`/`resolution` for admin handling

### Shared schemas
- Added/updated schemas under `packages/domain/schemas/` for:
  - capture visibility and rights basis enums
  - expanded `capture_public` to include `visibility`, attribution fields, and rights fields
  - reporting payloads (`create_report_*`, `report_*`, `admin_report_*`) and error codes

## Read-path enforcement (closing “public post bypasses”)
- A single policy function (`apps/api/src/groundedart_api/domain/attribution_rights.py:is_capture_publicly_visible`) defines public visibility and required fields.
- `GET /v1/nodes/{node_id}/captures`:
  - For non-admins: returns only captures that satisfy `is_capture_publicly_visible(...)` (so it never discloses `image_url` for non-public captures).
  - For admins (via `X-Admin-Token`): can query non-verified states for moderation, unchanged.

What this means for the system:
- “Verified captures” are no longer synonymous with “publicly visible captures”; public visibility is a stricter, explicit state.
- Any future discovery/feed/detail endpoint must apply the same policy to avoid reintroducing bypasses.

## Explicit publish path (owner-controlled, server-validated)
- Owners can update attribution/rights fields after capture creation via `PATCH /v1/captures/{capture_id}`.
  - `rights_attestation=true` sets `rights_attested_at` to the server timestamp; `false` clears it.
- Owners can publish via `POST /v1/captures/{capture_id}/publish`:
  - Requires `state == verified`.
  - Requires required attribution fields and rights attestation.
  - Sets `visibility = public` and records an auditable `capture_published` event.

What this means for the system:
- We can accept captures early (draft/pending/verified) without turning the product into a scrape/repost machine.
- “Publish” is a distinct, auditable action that can be reasoned about in moderation and future product UX.

## Reporting + takedown primitives (manual-first)
- Users can file a report via `POST /v1/captures/{capture_id}/reports` (authenticated; allowed for owners or publicly visible captures), with rate limiting (and rate-limit events logged to abuse events).
- Admin workflow:
  - `GET /v1/admin/reports` lists the queue.
  - `POST /v1/admin/reports/{report_id}/resolve` resolves and can hide the capture:
    - `hide_capture` transitions the capture to `hidden` with reason code `report_hide`.
    - `rights_takedown` transitions to `hidden` with reason code `rights_takedown`.
- Hidden captures no longer appear in node capture listings (and therefore their `image_url` is not disclosed via listing payloads).

## Web UX (current state)
- `apps/web/src/features/captures/CaptureFlow.tsx` collects attribution + rights inputs during capture submission so the data is available by the time a user wants to publish.
- `apps/web/src/routes/NodeDetailRoute.tsx` displays attribution alongside visible captures and includes a minimal “Report” UI for signed-in users.

## Areas we may still want to address
- **Server-side enum validation:** API currently accepts `rights_basis` as a string; enforcing the enum server-side would prevent invalid values from satisfying publish requirements.
- **Owner publish UX:** the API supports publish, but the web UI currently doesn’t expose a “Publish” action once a capture becomes verified.
- **Explainability to owners:** add an owner-facing view that shows why a capture is not public (missing fields, not verified, not published).
- **Media access control:** `/media` is a static mount; M5 prevents *API-disclosed* leaks, but fully access-controlled media delivery (signed URLs / auth-gated media route) is still a follow-on.
- **Tip receipt adapter seam (M5-06):** not implemented yet; see the deferred design notes in `docs/FUTUREOPTIONS.md`.
